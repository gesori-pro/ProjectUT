<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visual Novel Node Editor</title>
    <script src="https://cdn.jsdelivr.net/npm/litegraph.js@0.7.18/build/litegraph.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litegraph.js@0.7.18/css/litegraph.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Malgun Gothic', 'Segoe UI', sans-serif;
            background: #1a1a2e;
            color: #e8e8e8;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .toolbar {
            display: flex;
            gap: 10px;
            padding: 12px 20px;
            background: linear-gradient(180deg, #252540 0%, #1e1e35 100%);
            border-bottom: 1px solid rgba(100, 150, 255, 0.2);
            flex-wrap: wrap;
            align-items: center;
        }

        .toolbar-title {
            font-size: 18px;
            font-weight: bold;
            color: #7eb8da;
            margin-right: 20px;
        }

        .toolbar button {
            padding: 10px 20px;
            font-size: 13px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-family: inherit;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4a6fa5, #166d67);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(74, 111, 165, 0.4);
        }

        .btn-secondary {
            background: rgba(60, 60, 100, 0.8);
            color: #ccc;
            border: 1px solid rgba(100, 150, 255, 0.3);
        }

        .btn-secondary:hover {
            background: rgba(80, 80, 120, 0.9);
            color: white;
        }

        .btn-danger {
            background: rgba(180, 60, 60, 0.8);
            color: white;
        }

        .btn-danger:hover {
            background: rgba(200, 80, 80, 0.9);
        }

        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .canvas-container {
            flex: 1;
            position: relative;
            background: #202030;
        }

        #graphCanvas {
            width: 100%;
            height: 100%;
        }

        .sidebar {
            width: 350px;
            background: rgba(25, 25, 45, 0.95);
            border-left: 1px solid rgba(100, 150, 255, 0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 15px;
            background: rgba(40, 40, 70, 0.5);
            border-bottom: 1px solid rgba(100, 150, 255, 0.2);
        }

        .sidebar-header h3 {
            color: #7eb8da;
            font-size: 14px;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .output-area {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .output-area textarea {
            flex: 1;
            width: 100%;
            padding: 12px;
            border: none;
            background: rgba(15, 15, 30, 0.9);
            color: #a8d8b8;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            line-height: 1.5;
            resize: none;
        }

        .output-area textarea:focus {
            outline: none;
        }

        .help-panel {
            padding: 15px;
            background: rgba(30, 30, 50, 0.8);
            border-top: 1px solid rgba(100, 150, 255, 0.2);
        }

        .help-panel h4 {
            color: #7eb8da;
            margin-bottom: 10px;
            font-size: 13px;
        }

        .help-panel ul {
            list-style: none;
            font-size: 12px;
            color: #999;
        }

        .help-panel li {
            margin-bottom: 5px;
        }

        .help-panel kbd {
            background: rgba(60, 60, 100, 0.8);
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 11px;
            color: #ccc;
        }

        /* LiteGraph ìŠ¤íƒ€ì¼ ì˜¤ë²„ë¼ì´ë“œ */
        .litegraph .litecontextmenu {
            background: rgba(30, 30, 50, 0.98) !important;
            border: 1px solid rgba(100, 150, 255, 0.3) !important;
        }

        .litegraph .litecontextmenu .litemenu-entry {
            color: #e8e8e8 !important;
        }

        .litegraph .litecontextmenu .litemenu-entry:hover {
            background: rgba(74, 111, 165, 0.5) !important;
        }

        .node-info {
            font-size: 12px;
            color: #888;
            margin-bottom: 15px;
        }

        .stats-bar {
            display: flex;
            gap: 20px;
            padding: 8px 20px;
            background: rgba(20, 20, 40, 0.9);
            font-size: 12px;
            color: #888;
            border-top: 1px solid rgba(100, 150, 255, 0.1);
        }

        .stats-bar span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stats-bar .count {
            color: #7eb8da;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <div class="toolbar">
            <span class="toolbar-title">ğŸ® Visual Novel Node Editor</span>
            <button class="btn-primary" onclick="addDialogueNode()">+ ëŒ€ì‚¬ ë…¸ë“œ</button>
            <button class="btn-primary" onclick="addChoiceNode()">+ ì„ íƒì§€ ë…¸ë“œ</button>
            <button class="btn-secondary" onclick="loadFromFile()">ğŸ“‚ ìŠ¤í¬ë¦½íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸°</button>
            <button class="btn-primary" onclick="generateCode()">ğŸ’¾ ì½”ë“œ ìƒì„±</button>
            <button class="btn-primary" onclick="saveAsScriptData()">ğŸ“¥ script-data.js ì €ì¥</button>
            <button class="btn-secondary" onclick="copyCode()">ğŸ“‹ ë³µì‚¬</button>
            <button class="btn-secondary" onclick="saveGraph()">ğŸ’¾ ê·¸ë˜í”„ ì €ì¥</button>
            <button class="btn-secondary" onclick="loadGraph()">ğŸ“‚ ê·¸ë˜í”„ ë¶ˆëŸ¬ì˜¤ê¸°</button>
            <button class="btn-danger" onclick="clearGraph()">ğŸ—‘ï¸ ì´ˆê¸°í™”</button>
        </div>

        <div class="main-content">
            <div class="canvas-container">
                <canvas id="graphCanvas"></canvas>
            </div>

            <div class="sidebar">
                <div class="sidebar-header">
                    <h3>ìƒì„±ëœ ì½”ë“œ</h3>
                </div>
                <div class="sidebar-content">
                    <div class="node-info">
                        ë…¸ë“œë¥¼ ì—°ê²°í•˜ë©´ ì½”ë“œ ìƒì„± ì‹œ ìë™ìœ¼ë¡œ IDê°€ ë¶€ì—¬ë©ë‹ˆë‹¤.
                    </div>
                    <div class="output-area">
                        <textarea id="outputCode" readonly placeholder="ë…¸ë“œë¥¼ ì—°ê²°í•œ í›„ 'ì½”ë“œ ìƒì„±' ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”..."></textarea>
                    </div>
                </div>
                <div class="help-panel">
                    <h4>ğŸ¯ ì‚¬ìš©ë²•</h4>
                    <ul>
                        <li><kbd>ìš°í´ë¦­</kbd> ë…¸ë“œ ì¶”ê°€ ë©”ë‰´</li>
                        <li><kbd>ë“œë˜ê·¸</kbd> ë…¸ë“œ ì´ë™</li>
                        <li><kbd>ì¶œë ¥â†’ì…ë ¥</kbd> ì—°ê²°</li>
                        <li><kbd>Delete</kbd> ì„ íƒ ë…¸ë“œ ì‚­ì œ</li>
                        <li><kbd>Ctrl+ë“œë˜ê·¸</kbd> ìº”ë²„ìŠ¤ ì´ë™</li>
                        <li><kbd>íœ </kbd> í™•ëŒ€/ì¶•ì†Œ</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="stats-bar">
            <span>ëŒ€ì‚¬ ë…¸ë“œ: <span class="count" id="dialogueCount">0</span></span>
            <span>ì„ íƒì§€ ë…¸ë“œ: <span class="count" id="choiceCount">0</span></span>
            <span>ì—°ê²°: <span class="count" id="linkCount">0</span></span>
        </div>
    </div>

    <script>
        // LiteGraph ì„¤ì • - ì…ë ¥ì— ì—¬ëŸ¬ ì—°ê²° í—ˆìš© (ë¶„ê¸° í•©ë¥˜ ê°€ëŠ¥)
        LiteGraph.allow_multi_output_for_input = true;

        // LiteGraph ì´ˆê¸°í™”
        let graph = new LGraph();
        let canvas;

        // ========================================
        // ëŒ€ì‚¬ ë…¸ë“œ ì •ì˜ (ê°€ë¡œ ë°©í–¥)
        // ========================================
        function DialogueNode() {
            this.addInput("ì´ì „", -1);
            this.addOutput("ë‹¤ìŒ", -1);

            this.properties = {
                name: "",
                text: "",
                background: "",
                bgm: "",
                boxOpacity: ""
            };

            this.color = "#2a5a4a";
            this.bgcolor = "#1a3a2a";

            this.updateSize();
        }

        DialogueNode.title = "ëŒ€ì‚¬";
        DialogueNode.desc = "ëŒ€í™” ë˜ëŠ” ë‚˜ë ˆì´ì…˜";

        DialogueNode.prototype.updateSize = function () {
            // í…ìŠ¤íŠ¸ ì¤„ ìˆ˜ì— ë”°ë¼ ë†’ì´ ì¡°ì •
            const lines = this.properties.text ? this.properties.text.split('<br>').length : 1;
            const textHeight = Math.max(60, lines * 18 + 20);
            this.size = [400, 120 + textHeight];
        };

        DialogueNode.prototype.onDrawForeground = function (ctx) {
            if (!this.flags.collapsed) {
                ctx.font = "13px sans-serif";

                // í™”ì
                ctx.fillStyle = "#7eb8da";
                ctx.fillText("í™”ì: " + (this.properties.name || "(ë‚˜ë ˆì´ì…˜)"), 10, 35);

                // ëŒ€ì‚¬ (ì¤„ë°”ê¿ˆ ì²˜ë¦¬)
                ctx.fillStyle = "#e8e8e8";
                const textLines = this.properties.text.replace(/<br>/g, '\n').split('\n');
                let y = 55;
                textLines.forEach((line, i) => {
                    // ê¸´ ì¤„ì€ ìë™ ì¤„ë°”ê¿ˆ
                    const maxWidth = this.size[0] - 20;
                    let currentLine = '';
                    const words = line.split('');

                    for (let char of words) {
                        const testLine = currentLine + char;
                        const metrics = ctx.measureText(testLine);
                        if (metrics.width > maxWidth && currentLine) {
                            ctx.fillText(currentLine, 10, y);
                            currentLine = char;
                            y += 18;
                        } else {
                            currentLine = testLine;
                        }
                    }
                    if (currentLine) {
                        ctx.fillText(currentLine, 10, y);
                        y += 18;
                    }
                });

                // êµ¬ë¶„ì„ 
                y += 5;
                ctx.strokeStyle = "rgba(100,150,255,0.2)";
                ctx.beginPath();
                ctx.moveTo(10, y);
                ctx.lineTo(this.size[0] - 10, y);
                ctx.stroke();

                // ë°°ê²½/BGM ì •ë³´
                y += 15;
                ctx.fillStyle = "#888";
                ctx.font = "11px sans-serif";
                if (this.properties.background) {
                    ctx.fillText("ğŸ–¼ï¸ " + this.properties.background.split('/').pop(), 10, y);
                    y += 15;
                }
                if (this.properties.bgm) {
                    ctx.fillText("ğŸµ " + this.properties.bgm.split('/').pop(), 10, y);
                }
            }
        };

        DialogueNode.prototype.onDblClick = function (e, pos, graphCanvas) {
            this.openEditor();
        };

        DialogueNode.prototype.onMouseDown = function (e, pos, graphCanvas) {
            // ë…¸ë“œ ë‚´ë¶€ í´ë¦­ ì‹œ í¸ì§‘ ë‹¤ì´ì–¼ë¡œê·¸ ì—´ê¸° (ë”ë¸”í´ë¦­ ëŒ€ì‹  í•œ ë²ˆ í´ë¦­)
            if (e.detail === 2) { // ë”ë¸”í´ë¦­
                this.openEditor();
                return true;
            }
            return false;
        };

        DialogueNode.prototype.openEditor = function () {
            const self = this;
            const currentText = this.properties.text.replace(/<br>/g, '\n');

            const overlay = document.createElement('div');
            overlay.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.7); z-index: 10000;
                display: flex; align-items: center; justify-content: center;
            `;

            const dialog = document.createElement('div');
            dialog.style.cssText = `
                background: #1e1e35; border-radius: 12px; padding: 20px;
                border: 1px solid rgba(100,150,255,0.3); min-width: 500px;
            `;

            dialog.innerHTML = `
                <h3 style="color: #7eb8da; margin-bottom: 15px;">ğŸ“ ëŒ€ì‚¬ í¸ì§‘</h3>
                <div style="margin-bottom: 15px;">
                    <label style="color: #aaa; font-size: 12px;">í™”ì</label>
                    <input id="editName" type="text" value="${this.properties.name}" style="
                        width: 100%; padding: 8px; margin-top: 5px;
                        background: #15152a; color: #e8e8e8; border: 1px solid rgba(100,150,255,0.3);
                        border-radius: 6px; font-size: 14px;
                    ">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="color: #aaa; font-size: 12px;">ëŒ€ì‚¬ (ì—”í„° = ì¤„ë°”ê¿ˆ)</label>
                    <textarea id="editText" style="
                        width: 100%; height: 150px; padding: 10px; margin-top: 5px;
                        background: #15152a; color: #e8e8e8; border: 1px solid rgba(100,150,255,0.3);
                        border-radius: 6px; font-size: 14px; line-height: 1.6; resize: vertical;
                    ">${currentText}</textarea>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                    <div>
                        <label style="color: #aaa; font-size: 12px;">ë°°ê²½</label>
                        <input id="editBg" type="text" value="${this.properties.background}" placeholder="Background/xxx.png" style="
                            width: 100%; padding: 8px; margin-top: 5px;
                            background: #15152a; color: #e8e8e8; border: 1px solid rgba(100,150,255,0.3);
                            border-radius: 6px; font-size: 13px;
                        ">
                    </div>
                    <div>
                        <label style="color: #aaa; font-size: 12px;">BGM</label>
                        <input id="editBgm" type="text" value="${this.properties.bgm}" placeholder="bgm/xxx.mp3" style="
                            width: 100%; padding: 8px; margin-top: 5px;
                            background: #15152a; color: #e8e8e8; border: 1px solid rgba(100,150,255,0.3);
                            border-radius: 6px; font-size: 13px;
                        ">
                    </div>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="color: #aaa; font-size: 12px;">ëŒ€í™”ì°½ íˆ¬ëª…ë„ (0~1)</label>
                    <input id="editOpacity" type="text" value="${this.properties.boxOpacity}" placeholder="ë¹„ì›Œë‘ë©´ ê¸°ë³¸ê°’" style="
                        width: 100px; padding: 8px; margin-top: 5px;
                        background: #15152a; color: #e8e8e8; border: 1px solid rgba(100,150,255,0.3);
                        border-radius: 6px; font-size: 13px;
                    ">
                </div>
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button id="cancelBtn" style="
                        padding: 10px 20px; background: rgba(60,60,100,0.8); color: #ccc;
                        border: 1px solid rgba(100,150,255,0.3); border-radius: 6px; cursor: pointer;
                    ">ì·¨ì†Œ</button>
                    <button id="saveBtn" style="
                        padding: 10px 20px; background: linear-gradient(135deg, #4a6fa5, #166d67);
                        color: white; border: none; border-radius: 6px; cursor: pointer;
                    ">ì €ì¥</button>
                </div>
            `;

            overlay.appendChild(dialog);
            document.body.appendChild(overlay);

            document.getElementById('editText').focus();

            document.getElementById('saveBtn').onclick = function () {
                self.properties.name = document.getElementById('editName').value;
                self.properties.text = document.getElementById('editText').value.replace(/\n/g, '<br>');
                self.properties.background = document.getElementById('editBg').value;
                self.properties.bgm = document.getElementById('editBgm').value;
                self.properties.boxOpacity = document.getElementById('editOpacity').value;
                self.updateSize();
                document.body.removeChild(overlay);
            };

            document.getElementById('cancelBtn').onclick = function () {
                document.body.removeChild(overlay);
            };

            overlay.onclick = function (e) {
                if (e.target === overlay) document.body.removeChild(overlay);
            };
        };

        // ì—°ê²° ì‹œ ìƒˆ ì…ë ¥ ìŠ¬ë¡¯ ì¶”ê°€
        DialogueNode.prototype.onConnectionsChange = function (type, slotIndex, isConnected, link, ioSlot) {
            if (type === LiteGraph.INPUT && isConnected) {
                // ëª¨ë“  ì…ë ¥ ìŠ¬ë¡¯ì´ ì—°ê²°ë˜ì–´ ìˆìœ¼ë©´ ìƒˆ ìŠ¬ë¡¯ ì¶”ê°€
                let allConnected = true;
                for (let i = 0; i < this.inputs.length; i++) {
                    if (!this.inputs[i].link) {
                        allConnected = false;
                        break;
                    }
                }
                if (allConnected) {
                    this.addInput(`ì´ì „ ${this.inputs.length + 1}`, -1);
                    this.size[1] += 20;
                }
            }
            // ì—°ê²° í•´ì œ ì‹œ ë¹ˆ ìŠ¬ë¡¯ ì •ë¦¬ (ë§ˆì§€ë§‰ í•˜ë‚˜ëŠ” ìœ ì§€)
            if (type === LiteGraph.INPUT && !isConnected && this.inputs.length > 1) {
                // ì—°ê²° ì•ˆ ëœ ìŠ¬ë¡¯ ì¤‘ ë§ˆì§€ë§‰ ê²ƒë“¤ ì •ë¦¬
                let emptySlots = [];
                for (let i = this.inputs.length - 1; i >= 0; i--) {
                    if (!this.inputs[i].link) {
                        emptySlots.push(i);
                    } else {
                        break;
                    }
                }
                // ë¹ˆ ìŠ¬ë¡¯ì´ 2ê°œ ì´ìƒì´ë©´ í•˜ë‚˜ë§Œ ë‚¨ê¸°ê³  ì‚­ì œ
                while (emptySlots.length > 1) {
                    this.removeInput(emptySlots.shift());
                    this.size[1] -= 20;
                }
            }
        };

        LiteGraph.registerNodeType("VN/Dialogue", DialogueNode);

        // ========================================
        // ì„ íƒì§€ ë…¸ë“œ ì •ì˜
        // ========================================
        function ChoiceNode() {
            this.addInput("ì´ì „", -1);

            this.properties = {
                choices: [
                    { text: "ì„ íƒì§€ 1" },
                    { text: "ì„ íƒì§€ 2" }
                ]
            };

            this.setupWidgets();
            this.color = "#5a4a2a";
            this.bgcolor = "#3a3a1a";
        }

        ChoiceNode.title = "ì„ íƒì§€";
        ChoiceNode.desc = "ë¶„ê¸° ì„ íƒ";

        ChoiceNode.prototype.setupWidgets = function () {
            // ê¸°ì¡´ ìœ„ì ¯ ë° ì¶œë ¥ ì œê±°
            this.widgets = [];
            while (this.outputs && this.outputs.length > 0) {
                this.removeOutput(0);
            }

            // ê° ì„ íƒì§€ì— ëŒ€í•´ ìœ„ì ¯ê³¼ ì¶œë ¥ ì¶”ê°€
            this.properties.choices.forEach((choice, i) => {
                this.addWidget("text", `ì„ íƒ ${i + 1}`, choice.text, (v) => {
                    this.properties.choices[i].text = v;
                });
                this.addOutput(`ì„ íƒ ${i + 1}`, -1);
            });

            // ì„ íƒì§€ ì¶”ê°€/ì‚­ì œ ë²„íŠ¼
            this.addWidget("button", "+ ì„ íƒì§€ ì¶”ê°€", null, () => {
                this.properties.choices.push({ text: `ì„ íƒì§€ ${this.properties.choices.length + 1}` });
                this.setupWidgets();
            });

            if (this.properties.choices.length > 1) {
                this.addWidget("button", "- ë§ˆì§€ë§‰ ì‚­ì œ", null, () => {
                    if (this.properties.choices.length > 1) {
                        this.properties.choices.pop();
                        this.setupWidgets();
                    }
                });
            }

            this.size = [280, 60 + this.properties.choices.length * 30 + 60];
        };

        // ì—°ê²° ì‹œ ìƒˆ ì…ë ¥ ìŠ¬ë¡¯ ì¶”ê°€
        ChoiceNode.prototype.onConnectionsChange = function (type, slotIndex, isConnected, link, ioSlot) {
            if (type === LiteGraph.INPUT && isConnected) {
                let allConnected = true;
                for (let i = 0; i < this.inputs.length; i++) {
                    if (!this.inputs[i].link) {
                        allConnected = false;
                        break;
                    }
                }
                if (allConnected) {
                    this.addInput(`ì´ì „ ${this.inputs.length + 1}`, -1);
                    this.size[1] += 20;
                }
            }
            if (type === LiteGraph.INPUT && !isConnected && this.inputs.length > 1) {
                let emptySlots = [];
                for (let i = this.inputs.length - 1; i >= 0; i--) {
                    if (!this.inputs[i].link) {
                        emptySlots.push(i);
                    } else {
                        break;
                    }
                }
                while (emptySlots.length > 1) {
                    this.removeInput(emptySlots.shift());
                    this.size[1] -= 20;
                }
            }
        };

        LiteGraph.registerNodeType("VN/Choice", ChoiceNode);

        // ========================================
        // ì‹œì‘ ë…¸ë“œ ì •ì˜
        // ========================================
        function StartNode() {
            this.addOutput("ì‹œì‘", -1);
            this.size = [100, 40];
            this.color = "#4a4a8a";
            this.bgcolor = "#2a2a5a";
        }

        StartNode.title = "ì‹œì‘";
        StartNode.desc = "ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘ì ";

        LiteGraph.registerNodeType("VN/Start", StartNode);

        // ========================================
        // ìº”ë²„ìŠ¤ ì´ˆê¸°í™”
        // ========================================
        function initCanvas() {
            const canvasElement = document.getElementById("graphCanvas");
            canvas = new LGraphCanvas(canvasElement, graph);

            canvas.background_image = null;
            canvas.clear_background = true;
            canvas.render_canvas_border = false;
            canvas.default_link_color = "#7eb8da";

            // ìº”ë²„ìŠ¤ í¬ê¸° ì¡°ì •
            function resizeCanvas() {
                const container = canvasElement.parentElement;
                canvasElement.width = container.clientWidth;
                canvasElement.height = container.clientHeight;
                canvas.setDirty(true, true);
            }

            resizeCanvas();
            window.addEventListener("resize", resizeCanvas);

            graph.start();

            // ì‹œì‘ ë…¸ë“œ ì¶”ê°€
            const startNode = LiteGraph.createNode("VN/Start");
            startNode.pos = [100, 200];
            graph.add(startNode);

            updateStats();
        }

        // ========================================
        // ë…¸ë“œ ì¶”ê°€ í•¨ìˆ˜ë“¤
        // ========================================
        function addDialogueNode() {
            const node = LiteGraph.createNode("VN/Dialogue");
            node.pos = [300 + Math.random() * 200, 150 + Math.random() * 100];
            graph.add(node);
            updateStats();
        }

        function addChoiceNode() {
            const node = LiteGraph.createNode("VN/Choice");
            node.pos = [300 + Math.random() * 200, 150 + Math.random() * 100];
            graph.add(node);
            updateStats();
        }

        // ========================================
        // ê·¸ë˜í”„ íƒìƒ‰ ë° ì½”ë“œ ìƒì„±
        // ========================================
        function generateCode() {
            const nodes = graph._nodes;
            if (!nodes || nodes.length === 0) {
                alert("ë…¸ë“œê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ë…¸ë“œë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.");
                return;
            }

            // ì‹œì‘ ë…¸ë“œ ì°¾ê¸°
            const startNode = nodes.find(n => n.type === "VN/Start");
            if (!startNode) {
                alert("ì‹œì‘ ë…¸ë“œê°€ ì—†ìŠµë‹ˆë‹¤. ì‹œì‘ ë…¸ë“œë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.");
                return;
            }

            // BFSë¡œ ì—°ê²°ëœ ë…¸ë“œ ìˆœì„œëŒ€ë¡œ íƒìƒ‰
            const orderedNodes = [];
            const nodeIdMap = new Map(); // node -> assigned ID
            const visited = new Set();
            const queue = [];

            // ì‹œì‘ ë…¸ë“œì˜ ì—°ê²°ëœ ë…¸ë“œë¶€í„° ì‹œì‘
            const startLinks = startNode.outputs[0]?.links;
            if (startLinks && startLinks.length > 0) {
                startLinks.forEach(linkId => {
                    const link = graph.links[linkId];
                    if (link) {
                        const targetNode = graph.getNodeById(link.target_id);
                        if (targetNode && !visited.has(targetNode.id)) {
                            queue.push(targetNode);
                            visited.add(targetNode.id);
                        }
                    }
                });
            }

            // BFS íƒìƒ‰
            let currentId = 1;
            while (queue.length > 0) {
                const node = queue.shift();

                if (node.type !== "VN/Start") {
                    nodeIdMap.set(node.id, currentId++);
                    orderedNodes.push(node);
                }

                // ì—°ê²°ëœ ë‹¤ìŒ ë…¸ë“œë“¤ì„ íì— ì¶”ê°€
                if (node.outputs) {
                    node.outputs.forEach(output => {
                        if (output.links) {
                            output.links.forEach(linkId => {
                                const link = graph.links[linkId];
                                if (link) {
                                    const targetNode = graph.getNodeById(link.target_id);
                                    if (targetNode && !visited.has(targetNode.id)) {
                                        queue.push(targetNode);
                                        visited.add(targetNode.id);
                                    }
                                }
                            });
                        }
                    });
                }
            }

            if (orderedNodes.length === 0) {
                alert("ì‹œì‘ ë…¸ë“œì— ì—°ê²°ëœ ë…¸ë“œê°€ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            // ì½”ë“œ ìƒì„±
            let code = '// ê²Œì„ ì„¤ì •\n';
            code += 'const GAME_CONFIG = {\n';
            code += '    textSpeed: 30,      // í…ìŠ¤íŠ¸ íƒ€ì´í•‘ ì†ë„ (ms) - ë‚®ì„ìˆ˜ë¡ ë¹ ë¦„\n';
            code += '    autoDelay: 2000,    // ì˜¤í†  ëª¨ë“œì—ì„œ ë‹¤ìŒìœ¼ë¡œ ë„˜ì–´ê°€ëŠ” ë”œë ˆì´ (ms)\n';
            code += '    skipSpeed: 5,       // ìŠ¤í‚µ ëª¨ë“œ í…ìŠ¤íŠ¸ ì†ë„ (ms)\n';
            code += '};\n\n';
            code += 'const SCRIPT = [\n';

            orderedNodes.forEach((node, index) => {
                const assignedId = nodeIdMap.get(node.id);
                const p = node.properties;

                code += '    {\n';
                code += `        id: ${assignedId},\n`;

                if (node.type === "VN/Dialogue") {
                    if (p.background) code += `        background: "${p.background}",\n`;
                    if (p.bgm) code += `        bgm: "${p.bgm}",\n`;
                    if (p.name) code += `        name: "${p.name}",\n`;
                    if (p.text) code += `        text: "${p.text.replace(/"/g, '\\"')}",\n`;
                    if (p.boxOpacity !== '' && p.boxOpacity !== undefined && p.boxOpacity !== null) {
                        code += `        boxOpacity: ${p.boxOpacity},\n`;
                    }

                    // ì—°ê²°ëœ ë‹¤ìŒ ë…¸ë“œ ID ì°¾ê¸°
                    const links = node.outputs[0]?.links;
                    if (links && links.length > 0) {
                        const link = graph.links[links[0]];
                        if (link) {
                            const targetNode = graph.getNodeById(link.target_id);
                            if (targetNode && nodeIdMap.has(targetNode.id)) {
                                const nextId = nodeIdMap.get(targetNode.id);
                                // ë‹¤ìŒ IDê°€ ìˆœì°¨ì ì´ì§€ ì•Šì€ ê²½ìš°ë§Œ ëª…ì‹œ
                                if (nextId !== assignedId + 1) {
                                    code += `        nextId: ${nextId},\n`;
                                }
                            }
                        }
                    }
                } else if (node.type === "VN/Choice") {
                    code += '        choices: [\n';

                    p.choices.forEach((choice, cIndex) => {
                        let nextId = 0;
                        const outputLinks = node.outputs[cIndex]?.links;
                        if (outputLinks && outputLinks.length > 0) {
                            const link = graph.links[outputLinks[0]];
                            if (link) {
                                const targetNode = graph.getNodeById(link.target_id);
                                if (targetNode && nodeIdMap.has(targetNode.id)) {
                                    nextId = nodeIdMap.get(targetNode.id);
                                }
                            }
                        }

                        code += `            { text: "${choice.text.replace(/"/g, '\\"')}", nextId: ${nextId} }`;
                        code += cIndex < p.choices.length - 1 ? ',\n' : '\n';
                    });

                    code += '        ]\n';
                }

                code += '    }';
                code += index < orderedNodes.length - 1 ? ',\n' : '\n';
            });

            code += '];\n\n';
            code += '// ìŠ¤í¬ë¦½íŠ¸ ë§µ ìƒì„±\n';
            code += 'const SCRIPT_MAP = {};\n';
            code += 'SCRIPT.forEach((item, index) => {\n';
            code += '    SCRIPT_MAP[item.id] = { ...item, _index: index };\n';
            code += '});\n';

            document.getElementById('outputCode').value = code;
            updateStats();
        }

        // ========================================
        // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        // ========================================
        function copyCode() {
            const output = document.getElementById('outputCode');
            if (!output.value) {
                alert("ë¨¼ì € ì½”ë“œë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.");
                return;
            }
            output.select();
            document.execCommand('copy');
            alert('í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        function saveAsScriptData() {
            const output = document.getElementById('outputCode');
            if (!output.value) {
                // ì½”ë“œê°€ ì—†ìœ¼ë©´ ë¨¼ì € ìƒì„±
                generateCode();
            }

            const code = document.getElementById('outputCode').value;
            if (!code) {
                alert("ì €ì¥í•  ì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            const blob = new Blob([code], { type: 'text/javascript' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'script-data.js';
            a.click();
            URL.revokeObjectURL(url);
        }

        function clearGraph() {
            if (confirm("ëª¨ë“  ë…¸ë“œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                graph.clear();
                document.getElementById('outputCode').value = '';

                // ì‹œì‘ ë…¸ë“œ ë‹¤ì‹œ ì¶”ê°€
                const startNode = LiteGraph.createNode("VN/Start");
                startNode.pos = [100, 200];
                graph.add(startNode);

                updateStats();
            }
        }

        function saveGraph() {
            const data = JSON.stringify(graph.serialize(), null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'vn-graph.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function loadGraph() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        graph.configure(data);
                        updateStats();
                        alert('ê·¸ë˜í”„ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!');
                    } catch (err) {
                        alert('íŒŒì¼ ë¡œë“œ ì˜¤ë¥˜: ' + err.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function loadFromFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.js';
            input.onchange = (e) => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        parseAndCreateNodes(event.target.result);
                        alert('ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!');
                    } catch (err) {
                        alert('íŒŒì‹± ì˜¤ë¥˜: ' + err.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function parseAndCreateNodes(content) {
            // SCRIPT ë°°ì—´ ì¶”ì¶œ
            const safeContent = content
                .replace(/BACKGROUNDS\.\w+/g, '""')
                .replace(/CHARACTERS\.\w+(\?\.\w+)*/g, '""');

            const match = safeContent.match(/const SCRIPT\s*=\s*(\[[\s\S]*?\]);/);
            if (!match) {
                throw new Error('SCRIPT ë°°ì—´ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }

            const scriptArray = eval(match[1]);

            graph.clear();

            // ì‹œì‘ ë…¸ë“œ ì¶”ê°€
            const startNode = LiteGraph.createNode("VN/Start");
            startNode.pos = [50, 200];
            graph.add(startNode);

            let x = 250;
            const y = 200; // ê³ ì • Y ìœ„ì¹˜ë¡œ ì¼ì ì •ë ¬
            const nodeSpacing = 450; // ë…¸ë“œ ê°„ê²© (ë„“ê²Œ)
            const createdNodes = new Map(); // id -> node

            // ë…¸ë“œ ìƒì„± - ì¼ìë¡œ ì •ë ¬
            scriptArray.forEach((item, index) => {
                let node;

                if (item.choices) {
                    node = LiteGraph.createNode("VN/Choice");
                    node.properties.choices = item.choices.map(c => ({ text: c.text }));
                    node.setupWidgets();
                } else {
                    node = LiteGraph.createNode("VN/Dialogue");
                    // ìœ„ì ¯ ê°’ ì—…ë°ì´íŠ¸
                    node.properties.name = item.name || "";
                    node.properties.text = item.text || "";
                    node.properties.background = item.background || "";
                    node.properties.bgm = item.bgm || "";
                    node.properties.boxOpacity = item.boxOpacity !== undefined ? String(item.boxOpacity) : "";
                    node.updateSize();
                }

                node.pos = [x, y];
                graph.add(node);
                createdNodes.set(item.id, { node, item });

                x += nodeSpacing; // ì¼ìë¡œ ê³„ì† ì˜¤ë¥¸ìª½ìœ¼ë¡œ
            });

            // ì—°ê²° ìƒì„±
            let firstNode = null;
            scriptArray.forEach((item, index) => {
                const nodeData = createdNodes.get(item.id);
                if (!nodeData) return;

                if (index === 0) {
                    firstNode = nodeData.node;
                }

                if (item.choices) {
                    item.choices.forEach((choice, cIndex) => {
                        if (choice.nextId && createdNodes.has(choice.nextId)) {
                            const targetData = createdNodes.get(choice.nextId);
                            nodeData.node.connect(cIndex, targetData.node, 0);
                        }
                    });
                } else if (item.nextId && createdNodes.has(item.nextId)) {
                    const targetData = createdNodes.get(item.nextId);
                    nodeData.node.connect(0, targetData.node, 0);
                } else {
                    // ìˆœì°¨ ì—°ê²° (nextIdê°€ ì—†ìœ¼ë©´ ë‹¤ìŒ ì•„ì´í…œìœ¼ë¡œ)
                    const nextItem = scriptArray[index + 1];
                    if (nextItem && createdNodes.has(nextItem.id)) {
                        const targetData = createdNodes.get(nextItem.id);
                        nodeData.node.connect(0, targetData.node, 0);
                    }
                }
            });

            // ì‹œì‘ ë…¸ë“œì™€ ì²« ë…¸ë“œ ì—°ê²°
            if (firstNode) {
                startNode.connect(0, firstNode, 0);
            }

            updateStats();
        }

        function updateStats() {
            const nodes = graph._nodes || [];
            let dialogueCount = 0;
            let choiceCount = 0;

            nodes.forEach(node => {
                if (node.type === "VN/Dialogue") dialogueCount++;
                else if (node.type === "VN/Choice") choiceCount++;
            });

            const linkCount = Object.keys(graph.links || {}).length;

            document.getElementById('dialogueCount').textContent = dialogueCount;
            document.getElementById('choiceCount').textContent = choiceCount;
            document.getElementById('linkCount').textContent = linkCount;
        }

        // ì£¼ê¸°ì ìœ¼ë¡œ í†µê³„ ì—…ë°ì´íŠ¸
        setInterval(updateStats, 1000);

        // ì´ˆê¸°í™”
        window.onload = initCanvas;
    </script>
</body>

</html>